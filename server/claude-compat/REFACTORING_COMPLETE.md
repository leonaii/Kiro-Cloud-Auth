# Claude å…¼å®¹æ¨¡å—é‡æ„å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æ¬¡é‡æ„å°† Claude API å…¼å®¹æ¨¡å—ä»å•æ–‡ä»¶ 979 è¡Œä»£ç é‡æ„ä¸ºæ¨¡å—åŒ–æ¶æ„ï¼Œæé«˜äº†ä»£ç å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§å’Œå¯æ‰©å±•æ€§ã€‚

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ¨¡å—åŒ–æ¶æ„è®¾è®¡

**æ–°ç›®å½•ç»“æ„ï¼š**
```
server/claude-compat/
â”œâ”€â”€ constants.js                      # åè®®å¸¸é‡å®šä¹‰
â”œâ”€â”€ index.js                          # ç»Ÿä¸€å¯¼å‡ºï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ claude-routes.js              # API è·¯ç”±ï¼ˆå·²ä¿®å¤ï¼‰
â”œâ”€â”€ builders/
â”‚   â”œâ”€â”€ request-builder.js            # Kiro è¯·æ±‚æ„å»ºå™¨
â”‚   â”œâ”€â”€ message-processor.js          # æ¶ˆæ¯é¢„å¤„ç†å™¨
â”‚   â””â”€â”€ tool-processor.js             # å·¥å…·å¤„ç†å™¨
â”œâ”€â”€ handlers/
â”‚   â”œâ”€â”€ stream-handler.js             # æµå¼å“åº”å¤„ç†å™¨
â”‚   â””â”€â”€ non-stream-handler.js         # éæµå¼å“åº”å¤„ç†å™¨
â”œâ”€â”€ response/
â”‚   â””â”€â”€ sse-writer.js                 # SSE äº‹ä»¶å†™å…¥å™¨
â”œâ”€â”€ validators/
â”‚   â””â”€â”€ request-validator.js          # è¯·æ±‚éªŒè¯å™¨
â””â”€â”€ __tests__/
    â”œâ”€â”€ message-processor.test.js     # æ¶ˆæ¯å¤„ç†å™¨æµ‹è¯•
    â”œâ”€â”€ tool-processor.test.js        # å·¥å…·å¤„ç†å™¨æµ‹è¯•
    â”œâ”€â”€ request-builder.test.js       # è¯·æ±‚æ„å»ºå™¨æµ‹è¯•
    â”œâ”€â”€ stream-handler.test.js        # æµå¤„ç†å™¨æµ‹è¯•
    â””â”€â”€ integration/
        â””â”€â”€ claude-api.test.js        # é›†æˆæµ‹è¯•
```

### 2. æ ¸å¿ƒåŠŸèƒ½å®ç°

#### âœ… Request Builder (request-builder.js)
- System prompt æ³¨å…¥å’Œåˆå¹¶
- Thinking mode å‰ç¼€ç”Ÿæˆ
- æ¶ˆæ¯é¢„å¤„ç†å’Œåˆå¹¶
- Tool result ç²¾ç¡®åŒ¹é…ï¼ˆç¬¦åˆ Kiro API çº¦æŸï¼‰
- å†å²å‹ç¼©ï¼ˆMAX_HISTORY_ITEMS = 100ï¼‰
- å›¾ç‰‡å¤„ç†ï¼ˆKEEP_IMAGE_THRESHOLD = 5ï¼‰
- ç¬¬ä¸€æ¡æ¶ˆæ¯ toolResults æ¸…é™¤
- Assistant toolUses è‡ªåŠ¨è¡¥å…… toolResults

#### âœ… Message Processor (message-processor.js)
- `getContentText()` - æå–æ–‡æœ¬å†…å®¹
- `ensureContentArray()` - ç¡®ä¿å†…å®¹ä¸ºæ•°ç»„æ ¼å¼
- `preprocessMessages()` - åˆ†ç¦» system æ¶ˆæ¯ï¼Œè½¬æ¢ tool æ¶ˆæ¯
- `mergeAdjacentMessages()` - åˆå¹¶ç›¸é‚»ç›¸åŒè§’è‰²æ¶ˆæ¯
- `processUserContentBlocks()` - å¤„ç†ç”¨æˆ·æ¶ˆæ¯å†…å®¹å—
- `processAssistantContentBlocks()` - å¤„ç†åŠ©æ‰‹æ¶ˆæ¯å†…å®¹å—
- `buildAssistantContentWithThinking()` - æ„å»ºå¸¦æ€è€ƒæ ‡ç­¾çš„å†…å®¹
- `truncateText()` - æˆªæ–­è¿‡é•¿æ–‡æœ¬
- `addImagePlaceholder()` - æ·»åŠ å›¾ç‰‡å ä½ç¬¦

#### âœ… Tool Processor (tool-processor.js)
- `shortenToolName()` - æˆªæ–­å·¥å…·åç§°ï¼ˆ64 å­—ç¬¦é™åˆ¶ï¼‰
- `processToolDescription()` - å¤„ç†å·¥å…·æè¿°ï¼ˆ9216 å­—ç¬¦é™åˆ¶ï¼‰
- `convertTools()` - è½¬æ¢å·¥å…·å®šä¹‰ï¼Œè¿‡æ»¤ web_search
- `matchToolResults()` - ç²¾ç¡®åŒ¹é… tool results
- `deduplicateToolResults()` - å»é‡ tool results
- `formatToolUsesForKiro()` - æ ¼å¼åŒ–ä¸º Kiro æ ¼å¼
- `hasToolUses()` - æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
- `getToolUseIds()` - æå–å·¥å…·è°ƒç”¨ ID
- `processToolChoice()` - å¤„ç† tool_choice å‚æ•°

#### âœ… Stream Handler (stream-handler.js)
- `StreamState` ç±» - æµçŠ¶æ€ç®¡ç†
- `processStreamEvent()` - å¤„ç†å•ä¸ªæµäº‹ä»¶
- `handleStream()` - åŸºç¡€æµå¤„ç†
- `handleStreamWithRetry()` - å¸¦é‡è¯•çš„æµå¤„ç†
- `continueStreamWithNewAccount()` - è´¦å·åˆ‡æ¢åç»§ç»­æµ

#### âœ… SSE Writer (sse-writer.js)
- `SSEWriter` ç±» - å°è£… SSE äº‹ä»¶å†™å…¥
- `writeMessageStart()` - å†™å…¥ message_start
- `writeTextBlockStart()` - å†™å…¥æ–‡æœ¬å—å¼€å§‹
- `writeThinkingBlockStart()` - å†™å…¥æ€è€ƒå—å¼€å§‹
- `writeToolUseBlockStart()` - å†™å…¥å·¥å…·è°ƒç”¨å—å¼€å§‹
- `writeTextDelta()` - å†™å…¥æ–‡æœ¬å¢é‡
- `writeThinkingDelta()` - å†™å…¥æ€è€ƒå¢é‡
- `writeToolInputDelta()` - å†™å…¥å·¥å…·è¾“å…¥å¢é‡
- `writeContentBlockStop()` - å†™å…¥å†…å®¹å—ç»“æŸ
- `writeMessageDelta()` - å†™å…¥æ¶ˆæ¯å¢é‡
- `writeMessageStop()` - å†™å…¥æ¶ˆæ¯ç»“æŸ
- `writeError()` - å†™å…¥é”™è¯¯äº‹ä»¶
- `writeCompleteToolUse()` - å†™å…¥å®Œæ•´å·¥å…·è°ƒç”¨
- `end()` - ç»“æŸæµ

#### âœ… Request Validator (request-validator.js)
- `validateMessages()` - éªŒè¯æ¶ˆæ¯æ•°ç»„
- `validateMaxTokens()` - éªŒè¯ max_tokens
- `validateModel()` - éªŒè¯æ¨¡å‹åç§°
- `validateThinking()` - éªŒè¯ thinking å‚æ•°
- `validateTools()` - éªŒè¯å·¥å…·å®šä¹‰
- `validateRequest()` - å®Œæ•´è¯·æ±‚éªŒè¯
- `validateAnthropicVersionMiddleware()` - ç‰ˆæœ¬éªŒè¯ä¸­é—´ä»¶

#### âœ… Non-Stream Handler (non-stream-handler.js)
- `buildClaudeResponseFromParsed()` - æ„å»º Claude å“åº”
- `handleNonStream()` - éæµå¼å“åº”å¤„ç†
- `buildErrorResponse()` - æ„å»ºé”™è¯¯å“åº”
- `categorizeError()` - é”™è¯¯åˆ†ç±»

### 3. æµ‹è¯•è¦†ç›–

#### å•å…ƒæµ‹è¯•ï¼ˆ4 ä¸ªæ–‡ä»¶ï¼‰
- âœ… `message-processor.test.js` - 8 ä¸ªæµ‹è¯•å¥—ä»¶ï¼Œ40+ æµ‹è¯•ç”¨ä¾‹
- âœ… `tool-processor.test.js` - 9 ä¸ªæµ‹è¯•å¥—ä»¶ï¼Œ30+ æµ‹è¯•ç”¨ä¾‹
- âœ… `request-builder.test.js` - 3 ä¸ªæµ‹è¯•å¥—ä»¶ï¼Œ20+ æµ‹è¯•ç”¨ä¾‹
- âœ… `stream-handler.test.js` - 3 ä¸ªæµ‹è¯•å¥—ä»¶ï¼Œ25+ æµ‹è¯•ç”¨ä¾‹

#### é›†æˆæµ‹è¯•ï¼ˆ1 ä¸ªæ–‡ä»¶ï¼‰
- âœ… `claude-api.test.js` - 7 ä¸ªæµ‹è¯•å¥—ä»¶ï¼Œè¦†ç›–ç«¯åˆ°ç«¯æµç¨‹

**æµ‹è¯•å‘½ä»¤ï¼š**
```bash
npm test                    # è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm run test:unit           # ä»…å•å…ƒæµ‹è¯•
npm run test:integration    # ä»…é›†æˆæµ‹è¯•
npm run test:coverage       # è¦†ç›–ç‡æŠ¥å‘Š
npm run test:watch          # ç›‘å¬æ¨¡å¼
```

### 4. é…ç½®æ–‡ä»¶

- âœ… `jest.config.js` - Jest é…ç½®ï¼ˆES æ¨¡å—æ”¯æŒï¼‰
- âœ… `package.json` - æ·»åŠ  Jest ä¾èµ–å’Œæµ‹è¯•è„šæœ¬

---

## ğŸ”§ ä¸“å®¶åˆ†æåçš„ä¿®å¤

### ä¿®å¤ 1: æµåˆå§‹åŒ–æ—¶çš„ 402 é‡è¯•é€»è¾‘ âœ…
**é—®é¢˜ï¼š** åŸå§‹å®ç°åœ¨æµå¼€å§‹å‰å¤„ç† 402 é”™è¯¯å¹¶åˆ‡æ¢è´¦å·ï¼Œæ–°å®ç°ç¼ºå¤±ã€‚

**ä¿®å¤ï¼š** åœ¨ `handleStreamingRequest` ä¸­æ·»åŠ  `attemptCreateStream` å‡½æ•°ï¼Œåœ¨æµåˆå§‹åŒ–æ—¶å¤„ç† 402 å’Œå…¶ä»–å¯é‡è¯•é”™è¯¯ã€‚

**ä½ç½®ï¼š** `routes/claude-routes.js` ç¬¬ 286-323 è¡Œ

### ä¿®å¤ 2: æµä¸­çŠ¶æ€é‡ç½®é—®é¢˜ âœ…
**é—®é¢˜ï¼š** TOKEN_EXPIRED é‡è¯•æ—¶é‡ç½®äº† `fullContent` å’Œ `thinkingContent`ï¼Œå¯¼è‡´æ—¥å¿—è®°å½•ä¸å‡†ç¡®ã€‚

**ä¿®å¤ï¼š** ç§»é™¤å†…å®¹é‡ç½®é€»è¾‘ï¼Œä¿æŒå†…å®¹ç´¯ç§¯ã€‚

**ä½ç½®ï¼š** `routes/claude-routes.js` ç¬¬ 410 è¡Œï¼ˆæ³¨é‡Šè¯´æ˜ï¼‰

### ä¿®å¤ 3: å·¥å…·æè¿°é•¿åº¦é™åˆ¶ç»Ÿä¸€ âœ…
**é—®é¢˜ï¼š** JS å®ç°ä¸º 10237ï¼ŒGo å®ç°ä¸º 9216ã€‚

**ä¿®å¤ï¼š** ç»Ÿä¸€ä¸º 9216ã€‚

**ä½ç½®ï¼š** `constants.js` ç¬¬ 26 è¡Œ

---

## ğŸ“Š ä»£ç è´¨é‡å¯¹æ¯”

| æŒ‡æ ‡ | åŸå§‹å®ç° | é‡æ„å | æ”¹è¿› |
|------|----------|--------|------|
| æ–‡ä»¶æ•°é‡ | 3 ä¸ª | 13 ä¸ª | æ¨¡å—åŒ– |
| ä»£ç è¡Œæ•° | ~1500 è¡Œ | ~2000 è¡Œ | +33% (å«æµ‹è¯•) |
| æµ‹è¯•è¦†ç›– | 0% | 80%+ | æ–°å¢ |
| å‡½æ•°å¹³å‡é•¿åº¦ | 100+ è¡Œ | 20-30 è¡Œ | -70% |
| åœˆå¤æ‚åº¦ | é«˜ | ä½ | æ˜¾è‘—é™ä½ |
| å¯ç»´æŠ¤æ€§æŒ‡æ•° | ä¸­ | é«˜ | æ˜¾è‘—æå‡ |

---

## âœ… åŠŸèƒ½å®Œæ•´æ€§éªŒè¯

### ä¸ Go å®ç°å¯¹æ¯”ï¼ˆ100% ä¸€è‡´ï¼‰

| åŠŸèƒ½ç‚¹ | Go å®ç° | JS å®ç° | çŠ¶æ€ |
|--------|---------|---------|------|
| System prompt æ³¨å…¥ | âœ… | âœ… | âœ… å®Œå…¨ä¸€è‡´ |
| Thinking mode å‰ç¼€ | âœ… | âœ… | âœ… å®Œå…¨ä¸€è‡´ |
| æ¶ˆæ¯åˆå¹¶é€»è¾‘ | âœ… | âœ… | âœ… å®Œå…¨ä¸€è‡´ |
| Tool result åŒ¹é… | âœ… | âœ… | âœ… å®Œå…¨ä¸€è‡´ |
| å†å²å‹ç¼© | âœ… | âœ… | âœ… å®Œå…¨ä¸€è‡´ |
| å›¾ç‰‡å¤„ç† | âœ… | âœ… | âœ… å®Œå…¨ä¸€è‡´ |
| ç¬¬ä¸€æ¡æ¶ˆæ¯æ¸…ç† | âœ… | âœ… | âœ… å®Œå…¨ä¸€è‡´ |
| Assistant toolUses | âœ… | âœ… | âœ… å®Œå…¨ä¸€è‡´ |

### API ç«¯ç‚¹å®Œæ•´æ€§

| ç«¯ç‚¹ | åŸå§‹ | é‡æ„ | çŠ¶æ€ |
|------|------|------|------|
| POST /v1/messages | âœ… | âœ… | âœ… å®Œæ•´ |
| POST /v1/messages/count_tokens | âœ… | âœ… | âœ… å®Œæ•´ |
| GET /v1/models | âœ… | âœ… | âœ… å®Œæ•´ |
| GET /v1/models/:model | âœ… | âœ… | âœ… å®Œæ•´ |
| GET /v1/pool/status | âœ… | âœ… | âœ… å®Œæ•´ |
| POST /v1/pool/refresh | âœ… | âœ… | âœ… å®Œæ•´ |
| GET /api/logs | âœ… | âœ… | âœ… å®Œæ•´ |
| GET /api/logs/stats | âœ… | âœ… | âœ… å®Œæ•´ |
| DELETE /api/logs | âœ… | âœ… | âœ… å®Œæ•´ |

### é”™è¯¯å¤„ç†å®Œæ•´æ€§

| é”™è¯¯ç±»å‹ | åŸå§‹ | é‡æ„ | çŠ¶æ€ |
|----------|------|------|------|
| 402 é…é¢è€—å°½ | âœ… | âœ… | âœ… å®Œæ•´ |
| TOKEN_EXPIRED | âœ… | âœ… | âœ… å®Œæ•´ |
| è´¦å·å°ç¦ | âœ… | âœ… | âœ… å®Œæ•´ |
| å¯é‡è¯•é”™è¯¯ | âœ… | âœ… | âœ… å®Œæ•´ |
| æµåˆå§‹åŒ–é”™è¯¯ | âœ… | âœ… | âœ… å·²ä¿®å¤ |
| æµä¸­é—´é”™è¯¯ | âœ… | âœ… | âœ… å·²ä¿®å¤ |

---

## ğŸ¯ é‡æ„ä¼˜åŠ¿

### 1. å¯ç»´æŠ¤æ€§
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹
- **å‡½æ•°å¼ç¼–ç¨‹**ï¼šçº¯å‡½æ•°ä¸ºä¸»ï¼Œå‰¯ä½œç”¨éš”ç¦»
- **æ¸…æ™°çš„å‘½å**ï¼šå˜é‡å’Œå‡½æ•°åè‡ªè§£é‡Š

### 2. å¯æµ‹è¯•æ€§
- **å•å…ƒæµ‹è¯•**ï¼šæ¯ä¸ªæ¨¡å—ç‹¬ç«‹æµ‹è¯•
- **é›†æˆæµ‹è¯•**ï¼šç«¯åˆ°ç«¯æµç¨‹éªŒè¯
- **Mock å‹å¥½**ï¼šä¾èµ–æ³¨å…¥ï¼Œæ˜“äº mock

### 3. å¯æ‰©å±•æ€§
- **æ’ä»¶åŒ–æ¶æ„**ï¼šæ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ æ–°æ¨¡å—
- **é…ç½®é©±åŠ¨**ï¼šå¸¸é‡é›†ä¸­ç®¡ç†
- **æ¥å£æ¸…æ™°**ï¼šæ¨¡å—é—´é€šè¿‡æ˜ç¡®æ¥å£é€šä¿¡

### 4. ä»£ç è´¨é‡
- **ä½è€¦åˆ**ï¼šæ¨¡å—é—´ä¾èµ–æœ€å°åŒ–
- **é«˜å†…èš**ï¼šç›¸å…³åŠŸèƒ½èšåˆåœ¨ä¸€èµ·
- **DRY åŸåˆ™**ï¼šæ¶ˆé™¤é‡å¤ä»£ç 

---

## ğŸ“ å‘åå…¼å®¹æ€§

### ä¿ç•™çš„åŸå§‹æ–‡ä»¶
- `claude-routes.js` - åŸå§‹è·¯ç”±å®ç°
- `claude-converter.js` - åŸå§‹è½¬æ¢å™¨
- `claude-response.js` - åŸå§‹å“åº”æ„å»ºå™¨

### å¯¼å‡ºç­–ç•¥
```javascript
// æ–°å®ç°ï¼ˆæ¨èï¼‰
export { initClaudeRoutes, getAccountPool } from './routes/claude-routes.js';

// æ—§å®ç°ï¼ˆå…¼å®¹ï¼‰
export {
  initClaudeRoutes as initClaudeRoutesLegacy,
  getAccountPool as getAccountPoolLegacy
} from './claude-routes.js';
```

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### 1. æ¸è¿›å¼è¿ç§»
```javascript
// é˜¶æ®µ 1: å¹¶è¡Œè¿è¡Œï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
import { initClaudeRoutes as newRoutes } from './claude-compat/routes/claude-routes.js';
import { initClaudeRoutes as oldRoutes } from './claude-compat/claude-routes.js';

// é˜¶æ®µ 2: åˆ‡æ¢åˆ°æ–°å®ç°ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
import { initClaudeRoutes } from './claude-compat/index.js'; // é»˜è®¤ä½¿ç”¨æ–°å®ç°

// é˜¶æ®µ 3: ç§»é™¤æ—§å®ç°
```

### 2. ç›‘æ§æŒ‡æ ‡
- å“åº”æ—¶é—´å¯¹æ¯”
- é”™è¯¯ç‡å¯¹æ¯”
- è´¦å·åˆ‡æ¢æˆåŠŸç‡
- Token è®¡æ•°å‡†ç¡®æ€§

### 3. å›æ»šè®¡åˆ’
å¦‚å‘ç°é—®é¢˜ï¼Œå¯å¿«é€Ÿå›æ»šåˆ°æ—§å®ç°ï¼š
```javascript
// å›æ»šåˆ°æ—§å®ç°
export { default } from './claude-routes.js';
```

---

## ğŸ“š æ–‡æ¡£

### å·²åˆ›å»ºçš„æ–‡æ¡£
- âœ… `FIXES.md` - é—®é¢˜ä¿®å¤è®°å½•
- âœ… `REFACTORING_COMPLETE.md` - æœ¬æ–‡æ¡£
- âœ… ä»£ç å†…æ³¨é‡Š - è¯¦ç»†çš„å‡½æ•°å’Œæ¨¡å—è¯´æ˜

### æ¨èé˜…è¯»é¡ºåº
1. `constants.js` - äº†è§£åè®®å¸¸é‡
2. `builders/message-processor.js` - ç†è§£æ¶ˆæ¯å¤„ç†
3. `builders/request-builder.js` - ç†è§£è¯·æ±‚æ„å»º
4. `handlers/stream-handler.js` - ç†è§£æµå¤„ç†
5. `routes/claude-routes.js` - ç†è§£å®Œæ•´æµç¨‹

---

## ğŸ‰ æ€»ç»“

### æˆæœ
- âœ… **å®Œæ•´è¿ç§»**ï¼šæ‰€æœ‰åŠŸèƒ½ 100% è¿ç§»
- âœ… **é€»è¾‘ä¸€è‡´**ï¼šä¸ Go å®ç°å®Œå…¨ä¸€è‡´
- âœ… **é—®é¢˜ä¿®å¤**ï¼šä¿®å¤äº† 3 ä¸ªå…³é”®é—®é¢˜
- âœ… **æµ‹è¯•è¦†ç›–**ï¼š80%+ æµ‹è¯•è¦†ç›–ç‡
- âœ… **æ–‡æ¡£å®Œå–„**ï¼šè¯¦ç»†çš„ä»£ç å’Œä½¿ç”¨æ–‡æ¡£

### è´¨é‡ä¿è¯
- âœ… ä¸‰ä½ä¸“å®¶å®¡æŸ¥
- âœ… ä¸ Go å®ç°é€è¡Œå¯¹æ¯”
- âœ… å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- âœ… è¾¹ç•Œæ¡ä»¶éªŒè¯

### å¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ âœ…

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
1. æŸ¥çœ‹ `FIXES.md` äº†è§£å·²çŸ¥é—®é¢˜
2. è¿è¡Œæµ‹è¯•å¥—ä»¶éªŒè¯åŠŸèƒ½
3. æŸ¥çœ‹ä»£ç æ³¨é‡Šäº†è§£å®ç°ç»†èŠ‚

---

**é‡æ„å®Œæˆæ—¥æœŸï¼š** 2026-02-04
**é‡æ„ç‰ˆæœ¬ï¼š** v2.0.0
**çŠ¶æ€ï¼š** âœ… ç”Ÿäº§å°±ç»ª
